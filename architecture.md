# LLM-EduHub架构设计文档

## 1. 整体架构概览

```
┌─────────────────┐      ┌───────────────────┐      ┌─────────────────┐      ┌─────────────┐
│                 │      │                   │      │                 │      │             │
│  前端应用层       │──────▶   Next.js API层   │──────▶   服务集成层      │──────▶  数据存储层  │
│  React + TS     │      │   路由和中间件      │      │  Supabase API   │      │ PostgreSQL  │
│  Tailwind CSS   │◀─────│                   │◀─────│  Dify API       │◀─────│ (Supabase)  │
│                 │      │                   │      │                 │      │             │
└─────────────────┘      └───────────────────┘      └─────────────────┘      └─────────────┘
```

LLM-EduHub采用现代化的四层架构设计，结合Next.js App Router的最佳实践，实现前端、API、服务集成和数据存储的无缝衔接。这种分层设计确保了关注点分离，使系统更易于维护和扩展。

## 2. 前端架构

### 技术栈
- **框架**: React 18+
- **类型系统**: TypeScript
- **样式方案**: Tailwind CSS
- **构建工具**: Next.js (App Router)

### 目录结构设计
```
app/
  ├── (components)/             # 组件目录（建议添加）
  │   ├── ui/                   # 通用UI组件
  │   │   ├── Button.tsx
  │   │   ├── Input.tsx
  │   │   └── ...
  │   ├── layout/               # 布局组件
  │   │   ├── Header.tsx
  │   │   ├── Sidebar.tsx
  │   │   └── ...
  │   └── features/             # 功能组件
  │       ├── chat/             # 聊天相关组件
  │       ├── auth/             # 认证相关组件
  │       └── ...
  ├── (lib)/                    # 工具和配置
  ├── (hooks)/                  # 自定义React Hooks（建议添加）
  ├── (store)/                  # 全局状态管理（建议添加）
  ├── (types)/                  # 类型定义（建议添加）
  ├── [feature-page]/           # 功能页面
  │   └── page.tsx
  └── ...
```

> **注意**：目录名称周围的括号 `()` 是Next.js App Router的特殊约定，表示这些目录不会被视为路由段。这样做可以将共享代码和组件放在`app/`目录下，而不会影响路由结构。

### 状态管理
- **本地状态**: React useState/useReducer
- **全局状态**: React Context API或轻量级状态库（推荐Zustand或Jotai）
- **服务器状态**: SWR或React Query用于数据获取和缓存

## 3. API层设计

### API路由结构
```
app/api/
  ├── auth/                     # 认证相关API
  │   ├── identify/             # 用户身份识别
  │   ├── profile/              # 用户资料管理（建议添加）
  │   └── sso/                  # 单点登录
  ├── chat/                     # 聊天相关API（建议添加）
  │   ├── history/              # 聊天历史记录
  │   └── message/              # 消息处理
  ├── dify/                     # Dify API集成
  │   └── [appId]/[...slug]/    # 动态路由处理
  └── models/                   # 模型管理API（建议添加）
      └── [provider]/           # 按提供商分类
```

### 中间件设计
中间件主要分为两类：

1. **Edge中间件**：位于项目根目录的`middleware.ts`文件，运行在Edge运行时环境，在路由解析前处理所有传入请求。主要负责：
   - 认证状态验证
   - 基本的请求检查
   - 路由重定向
   - CORS配置
   - 请求频率限制

2. **API路由中间件**：在具体API路由处理函数内部使用的逻辑组件，负责：
   - API密钥管理和验证
   - 请求参数验证
   - 详细请求日志
   - 错误处理和格式化

## 4. 数据存储设计

### Supabase表结构

```
├── auth.users                 # Supabase内置用户表
│   ├── id
│   ├── email
│   ├── created_at
│   └── ...
├── user_profiles              # 用户资料
│   ├── user_id (FK -> auth.users.id)
│   ├── display_name
│   ├── avatar_url
│   └── ...
├── chat_sessions              # 聊天会话
│   ├── id
│   ├── user_id (FK -> auth.users.id)
│   ├── title
│   ├── created_at
│   └── ...
├── chat_messages              # 聊天消息
│   ├── id
│   ├── session_id (FK -> chat_sessions.id)
│   ├── role (user/assistant)
│   ├── content
│   ├── created_at
│   └── ...
├── model_providers            # 模型提供商
│   ├── id
│   ├── name
│   ├── api_base
│   └── ...
└── api_keys                   # API密钥管理
    ├── id
    ├── provider_id (FK -> model_providers.id)
    ├── key_value (加密存储)
    ├── usage_count
    └── ...
```

### 存储策略
- 敏感数据（如API密钥）使用Supabase提供的行级安全性(RLS)和服务器端加密
- 大型数据（如聊天历史）考虑分页加载和增量同步
- 实时功能（如聊天）利用Supabase的实时订阅功能

## 5. 认证流程

### 认证方式
- Supabase内置认证（邮箱/密码）
- OAuth社交登录（GitHub, Google等）
- 企业SSO集成

### 认证流程图
```
用户 → 登录请求 → Next.js API(auth/...) → Supabase Auth → JWT令牌
  ↓
保存令牌 → 客户端状态更新 → 受保护资源访问 → API中间件验证
```

## 6. AI模型集成

### Dify API集成
- 使用代理模式将前端请求安全地转发到Dify API
- 在代理层处理API密钥管理和请求转换
- 支持流式响应和错误处理

### 多模型供应商架构
```
客户端请求 → Next.js API → 模型路由层 → Dify API / 其他模型提供商
                             ↑
                        模型配置管理
                        API密钥管理
```

**模型路由决策逻辑**：
- 基于用户在界面中的明确选择
- 考虑配置的使用限额和成本控制
- 根据请求特性选择最适合的模型（如需要流式响应的对话选用支持流式的模型）
- 提供自动故障转移能力，当首选模型不可用时切换到备选模型

### 模型调用优化
- 实现请求缓存减少重复调用
- 添加重试机制处理临时故障
- 实现模型回退策略确保可用性

## 7. 部署和扩展策略

### 部署选项
- **开发环境**: 本地开发服务器
- **测试环境**: Vercel预览部署
- **生产环境**: Vercel或其他云服务提供商

### 扩展考虑
- 使用Edge Functions提高全球性能
- 实现细粒度缓存策略减少API调用
- 考虑无服务器数据库连接池管理大量连接

## 8. 安全性考虑

### 数据安全
- API密钥等敏感信息仅在服务器端处理
- 实现请求来源验证防止未授权访问
- 定期轮换密钥和令牌

### 输入验证
- 对所有API输入实施严格验证
- 实现内容过滤防止潜在的LLM注入攻击，具体策略包括：
  - 使用输入清理库（如DOMPurify）处理用户输入
  - 实施输入长度和格式限制
  - 移除或转义潜在的指令注入模式
  - 实现提示模板隔离，避免用户输入直接拼接到系统提示中
  - 对模型输出进行后处理，检测并过滤不适当内容
- 限制请求大小和频率

## 9. 后续开发路线图

### 近期计划
- 完善基础组件库
- 实现核心认证流程
- 建立Dify API代理的完整功能

### 中期目标
- 添加用户资料和偏好设置
- 实现高级聊天功能（历史、保存等）
- 添加多模型切换能力

### 长期愿景
- 构建高级分析仪表板
- 实现企业级权限管理
- 支持自定义模型微调和部署

## 10. 参考资源

- Next.js App Router文档
- Supabase文档中的身份验证和数据库指南
- Dify API文档和集成示例
- Tailwind CSS设计系统最佳实践

这份架构文档提供了LLM-EduHub项目的整体设计蓝图，应根据项目进展和需求变化定期更新。
